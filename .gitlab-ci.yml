stages:
  - build
  - migrations-users

build:
  stage: build
  tags:
    - docker
  script: 
    - docker build -t $CI_REGISTRY/gateway/$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY/gateway
  when: manual

migrations-users:
  stage: migrations-users
  image: igorfilin/node20_vault:v1.1
  tags: 
    - docker
  variables:
    VAULT_ADDR: $VAULT_ADDR
  script:
    - which jq
    - echo "Проверка доступности Vault..."
    - curl -v "$VAULT_ADDR/v1/sys/health"
    - export VAULT_TOKEN=$( vault write -field=token auth/approle/login role_id="$VAULT_ROLE_ID" secret_id="$VAULT_SECRET_ID" )
    - JSON_DATA=$(vault kv get -mount=kv -format=json external-secrets)
    - echo "/usr/bin/jq -r '.data.data | to_entries[] | "\(.key)=\"\(.value // "null")\""' > .env
    - npm add --global nx
    - npx nx migration:run user-service
  # rules:
  #   - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  when: manual